// –î–∞–Ω–Ω—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä
const apartments = {
    1: {
        title: "–ö–≤–∞—Ä—Ç–∏—Ä–∞ 1",
        number: "‚Ññ118",
        type: "–û–¥–Ω–æ–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞",
        location: "–ñ–ö ¬´–ë–µ–ª—ã–π –∞–Ω–≥–µ–ª¬ª, –ë–µ—Ä–µ–≥–æ–≤–∞—è 6",
        price: "4 000 ‚ÇΩ",
        description: "–ü—Ä–æ—Å—Ç–æ—Ä–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ —Å –ø–∞–Ω–æ—Ä–∞–º–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —Ä–µ–º–æ–Ω—Ç–æ–º. –ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø–∞—Ä –∏–ª–∏ –Ω–µ–±–æ–ª—å—à–æ–π —Å–µ–º—å–∏. –ï—Å—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–Ω–∞—è –∫—É—Ö–Ω—è –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞.",
        images: [
            "images/apartment-1-1.jpg",
            "images/apartment-1-2.jpg",
            // ...
        ]
    },
    2: {
        title: "–ö–≤–∞—Ä—Ç–∏—Ä–∞ 2",
        number: "‚Ññ131",
        type: "–û–¥–Ω–æ–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞",
        location: "–ñ–ö ¬´–ë–µ–ª—ã–π –∞–Ω–≥–µ–ª¬ª, –ë–µ—Ä–µ–≥–æ–≤–∞—è 6",
        price: "4 000 ‚ÇΩ",
        description: "–î–≤—É—Ö–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ —Å –≤–∏–¥–æ–º –Ω–∞ –≥–æ—Ä–æ–¥. –ü—Ä–æ—Å—Ç–æ—Ä–Ω–∞—è –≥–æ—Å—Ç–∏–Ω–∞—è –∏ —É—é—Ç–Ω–∞—è —Å–ø–∞–ª—å–Ω—è. –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∫—É—Ö–Ω—è-–≥–æ—Å—Ç–∏–Ω–∞—è –∏ –±–æ–ª—å—à–∞—è –≤–∞–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞.",
        images: [
            "images/apartment-2-1.jpg",
            // ...
        ]
    },
    3: {
        title: "–ö–≤–∞—Ä—Ç–∏—Ä–∞ 3",
        number: "‚Ññ144",
        type: "–°—Ç—É–¥–∏—è",
        location: "–ñ–ö ¬´–ë–µ–ª—ã–π –∞–Ω–≥–µ–ª¬ª, –ë–µ—Ä–µ–≥–æ–≤–∞—è 6",
        price: "4 000 ‚ÇΩ",
        description: "–°–≤–µ—Ç–ª–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞-—Å—Ç—É–¥–∏—è —Å –ø–∞–Ω–æ—Ä–∞–º–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏. –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –º–æ–ª–æ–¥—ã—Ö –ø–∞—Ä –∏–ª–∏ –±–∏–∑–Ω–µ—Å-–ø–æ–µ–∑–¥–æ–∫.",
        images: [
            "images/apartment-3-1.jpg",
            // ...
        ]
    },
    4: {
        title: "–ö–≤–∞—Ä—Ç–∏—Ä–∞ 4",
        number: "‚Ññ196",
        type: "–î–≤—É—Ö–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞",
        location: "–ñ–ö ¬´–ë–µ–ª—ã–π –∞–Ω–≥–µ–ª¬ª, –ë–µ—Ä–µ–≥–æ–≤–∞—è 6",
        price: "4 000 ‚ÇΩ",
        description: "–ü—Ä–æ—Å—Ç–æ—Ä–Ω–∞—è —Ç—Ä—ë—Ö–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ –¥–ª—è —Å–µ–º—å–∏. –î–≤–µ —Å–ø–∞–ª—å–Ω–∏, –≥–æ—Å—Ç–∏–Ω–∞—è –∏ –±–æ–ª—å—à–∞—è –∫—É—Ö–Ω—è. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Å–µ–º–µ–π–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞ –∏–ª–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è.",
        images: [
            "images/apartment-4-1.jpg",
            // ...
        ]
    },
    5: {
        title: "–ö–≤–∞—Ä—Ç–∏—Ä–∞ 5",
        number: "‚Ññ214",
        type: "–û–¥–Ω–æ–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞",
        location: "–ñ–ö ¬´–ë–µ–ª—ã–π –∞–Ω–≥–µ–ª¬ª, –ë–µ—Ä–µ–≥–æ–≤–∞—è 6",
        price: "4 000 ‚ÇΩ",
        description: "–£—é—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –µ–≤—Ä–æ—Ä–µ–º–æ–Ω—Ç–æ–º. –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–¥–µ–ª–æ—á–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –Ω–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞. –û—Ç–ª–∏—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–≥–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è.",
        images: [
            "images/apartment-5-1.jpg",
            // ...
        ]
    }
};

function setupRoomsSlider() {
    const img      = document.getElementById('roomsSliderImage');
    const priceEl  = document.getElementById('roomsSliderPrice');
    const numEl    = document.getElementById('roomsSliderNumber');
    const typeEl   = document.getElementById('roomsSliderType');
    const locEl    = document.getElementById('roomsSliderLocation');
    const moreBtn  = document.getElementById('roomsSliderMore');
    const dotsBox  = document.getElementById('roomsSliderDots');
    const dots     = dotsBox ? dotsBox.querySelectorAll('.rooms-dot') : [];
    const prevBtn  = document.querySelector('.rooms-slider-arrow-prev');
    const nextBtn  = document.querySelector('.rooms-slider-arrow-next');

    if (!img || !dots.length) return;

    let currentIndex = 0; // –∏–Ω–¥–µ–∫—Å —Ç–æ—á–∫–∏ (0..N-1)

    function applyByIndex(i) {
        const dot = dots[i];
        if (!dot) return;

        const aptId = Number(dot.getAttribute('data-apartment-id'));
        const apt   = apartments[aptId];
        if (!apt || !apt.images || !apt.images.length) return;

        currentIndex = i;

        // —Ç–æ—á–∫–∏
        dots.forEach(d => d.classList.remove('active'));
        dot.classList.add('active');

        // —Ñ–æ—Ç–æ
        img.src = apt.images[0];
        img.alt = `${apt.title} ‚Äî —Ñ–æ—Ç–æ`;
        img.dataset.apartmentId = String(aptId);

        // —Ç–µ–∫—Å—Ç
        if (priceEl) priceEl.textContent = apt.price;
        if (numEl)   numEl.textContent   = apt.number;
        if (typeEl)  typeEl.textContent  = apt.type;
        if (locEl)   locEl.textContent   = apt.location;
    }

    // –∫–ª–∏–∫–∏ –ø–æ —Ç–æ—á–∫–∞–º
    dots.forEach((dot, i) => {
        dot.addEventListener('click', () => applyByIndex(i));
    });

    // —Å—Ç—Ä–µ–ª–∫–∏
    prevBtn && prevBtn.addEventListener('click', () => {
        const i = (currentIndex - 1 + dots.length) % dots.length;
        applyByIndex(i);
    });

    nextBtn && nextBtn.addEventListener('click', () => {
        const i = (currentIndex + 1) % dots.length;
        applyByIndex(i);
    });

    // —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –∞–∫—Ç–∏–≤–Ω–∞—è —Ç–æ—á–∫–∞ –∏–ª–∏ –ø–µ—Ä–≤–∞—è
    const initialIndex = Array.from(dots).findIndex(d => d.classList.contains('active'));
    applyByIndex(initialIndex >= 0 ? initialIndex : 0);

    // "–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ" ‚Äî –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    if (moreBtn) {
        moreBtn.addEventListener('click', () => {
            const aptId = Number(img.dataset.apartmentId || '1');
            // –∑–¥–µ—Å—å –º–æ–∂–µ–º –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å ID –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ —Ñ–æ—Ä–º—É
            openBookingModal(String(aptId));
        });
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
function setupImageErrorHandling() {
    document.querySelectorAll('.card-image img, .about-img').forEach(img => {
        img.addEventListener('error', function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmYWZjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk0YTBhZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBmb3VuZDwvdGV4dD48L3N2Zz4=';
            this.alt = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
            this.classList.add('image-fallback');
        });
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏
function preloadImages(imageUrls) {
    imageUrls.forEach(src => {
        const img = new Image();
        img.src = src;
    });
}

// –§—É–Ω–∫—Ü–∏—è –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –∫–≤–∞—Ä—Ç–∏—Ä
function setupLazyLoading() {
  // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º: –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π loading="lazy" + decoding="async"
  document.querySelectorAll('.card-image img').forEach(img => {
    img.setAttribute('loading','lazy');
    img.setAttribute('decoding','async');
  });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–∞—Å–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
function setupPhoneMask() {
    const phoneInput = document.getElementById('bookingPhone');
    if (!phoneInput) return;

    phoneInput.value = '+7 (';
    
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        
        if (value.startsWith('7') || value.startsWith('8')) {
            value = value.substring(1);
        }
        
        if (value.length > 10) {
            value = value.substring(0, 10);
        }
        
        let formattedValue = '+7 (';
        
        if (value.length > 0) {
            formattedValue += value.substring(0, 3);
        }
        if (value.length > 3) {
            formattedValue += ') ' + value.substring(3, 6);
        }
        if (value.length > 6) {
            formattedValue += '-' + value.substring(6, 8);
        }
        if (value.length > 8) {
            formattedValue += '-' + value.substring(8, 10);
        }
        
        e.target.value = formattedValue;
    });

    phoneInput.addEventListener('blur', function() {
        const digits = this.value.replace(/\D/g, '');
        if (digits.length !== 11) {
            this.style.borderColor = '#ef4444';
            this.style.backgroundColor = '#fef2f2';
        } else {
            this.style.borderColor = '';
            this.style.backgroundColor = '';
        }
    });

    phoneInput.addEventListener('focus', function() {
        this.style.borderColor = '';
        this.style.backgroundColor = '';
    });

    phoneInput.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' || e.key === 'Delete') {
            if (this.value.length <= 4) {
                e.preventDefault();
                this.value = '+7 (';
            }
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
function validatePhone(phone) {
    const digits = phone.replace(/\D/g, '');
    return digits.length === 11;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ UX
function enhanceMobileUX() {
    let touchStartX = 0;
    let touchEndX = 0;
    
    document.addEventListener('touchstart', function(e) {
        if (e.target.closest('.modal-gallery')) {
            touchStartX = e.changedTouches[0].screenX;
        }
    }, { passive: true });
    
    document.addEventListener('touchend', function(e) {
        if (e.target.closest('.modal-gallery')) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }
    }, { passive: true });
    
    function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;
        
        if (Math.abs(diff) > swipeThreshold) {
            if (diff > 0) {
                nextImage();
            } else {
                prevImage();
            }
        }
    }
}

function setupHeaderScroll() {
    const header = document.querySelector('.header');
    const hero = document.querySelector('.hero');
    
    if (!header || !hero) return;
    
    function updateHeader() {
        const scrollY = window.scrollY;
        const heroHeight = hero.offsetHeight;
        
        if (scrollY > heroHeight - 100) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
    }
    
    window.addEventListener('scroll', updateHeader);
    updateHeader();
}

let currentApartment = null;
let currentImageIndex = 0;

// –í–°–¢–ê–í–ò–¢–¨ –ü–ï–†–ï–î openApartmentModal
function trapFocus(modal) {
  const focusables = modal.querySelectorAll('a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])');
  if (!focusables.length) return;
  const first = focusables[0], last = focusables[focusables.length - 1];
  function loop(e){
    if (e.key !== 'Tab') return;
    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
  }
  modal.addEventListener('keydown', loop);
  setTimeout(() => first.focus(), 0);
}

// –§—É–Ω–∫—Ü–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≥–∞–ª–µ—Ä–µ–∏
function openApartmentModal(apartmentId) {
    currentApartment = apartments[apartmentId];
    currentImageIndex = 0;
    
    const modal = document.getElementById('apartmentModal');
    modal.setAttribute('role','dialog');
    modal.setAttribute('aria-modal','true');
    trapFocus(modal);
    
    if (!currentApartment) {
        console.error('–ö–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', apartmentId);
        return;
    }
    
    preloadImages(currentApartment.images);
    updateGallery();
    
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    setTimeout(() => {
        document.querySelectorAll('.modal-gallery img, .modal-thumbnails img').forEach(img => {
            img.addEventListener('error', function() {
                this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmYWZjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk0YTBhZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBmb3VuZDwvdGV4dD48L3N2Zz4=';
                this.alt = '–§–æ—Ç–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                this.classList.add('image-fallback');
            });
        });
    }, 100);
}

function updateGallery() {
    const gallery = document.querySelector('.modal-gallery');
    const thumbnails = document.getElementById('modalThumbnails');
    
    if (!currentApartment || !currentApartment.images.length) return;
    
    gallery.innerHTML = `
        <div class="main-image-container">
            <img src="${currentApartment.images[currentImageIndex]}" alt="${currentApartment.title} - –§–æ—Ç–æ ${currentImageIndex + 1}" class="main-image">
            <button class="gallery-nav gallery-prev" onclick="prevImage()" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Ñ–æ—Ç–æ">‚Äπ</button>
            <button class="gallery-nav gallery-next" onclick="nextImage()" aria-label="–°–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ">‚Ä∫</button>
            <div class="image-counter">${currentImageIndex + 1} / ${currentApartment.images.length}</div>
        </div>
    `;
    
    thumbnails.innerHTML = '';
    currentApartment.images.forEach((imageSrc, index) => {
        const thumb = document.createElement('img');
        thumb.src = imageSrc;
        thumb.alt = `–ú–∏–Ω–∏–∞—Ç—é—Ä–∞ ${index + 1}`;
        thumb.className = `thumbnail ${index === currentImageIndex ? 'active' : ''}`;
        thumb.onclick = () => changeImage(index);
        thumbnails.appendChild(thumb);
    });
}

function changeImage(index) {
    currentImageIndex = index;
    updateGallery();
}

function nextImage() {
    if (!currentApartment) return;
    currentImageIndex = (currentImageIndex + 1) % currentApartment.images.length;
    updateGallery();
}

function prevImage() {
    if (!currentApartment) return;
    currentImageIndex = (currentImageIndex - 1 + currentApartment.images.length) % currentApartment.images.length;
    updateGallery();
}

function closeApartmentModal() {
    const modal = document.getElementById('apartmentModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    currentApartment = null;
    currentImageIndex = 0;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
function openBookingModal(apartmentId = '') {
    const modal = document.getElementById('bookingModal');
    modal.setAttribute('role','dialog');
    modal.setAttribute('aria-modal','true');
    trapFocus(modal);
    
    if (apartmentId && document.getElementById('bookingApartment')) {
        document.getElementById('bookingApartment').value = apartmentId;
    }
    
    const today = new Date().toISOString().split('T')[0];
    const checkinInput = document.getElementById('bookingCheckin');
    const checkoutInput = document.getElementById('bookingCheckout');
    
    if (checkinInput) {
        checkinInput.min = today;
        checkinInput.value = '';
    }
    if (checkoutInput) {
        checkoutInput.min = today;
        checkoutInput.value = '';
    }
    
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeBookingModal() {
    const modal = document.getElementById('bookingModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã
function validateBookingForm() {
    const checkin = document.getElementById('bookingCheckin');
    const checkout = document.getElementById('bookingCheckout');
    const name = document.getElementById('bookingName');
    const phone = document.getElementById('bookingPhone');
    const apartment = document.getElementById('bookingApartment');
    
    if (!checkin || !checkout || !name || !phone || !apartment) {
        alert('–û—à–∏–±–∫–∞: –Ω–µ –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã –Ω–∞–π–¥–µ–Ω—ã');
        return false;
    }
    
    if (!checkin.value || !checkout.value || !name.value || !phone.value || !apartment.value) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
        return false;
    }
    
    if (checkout.value <= checkin.value) {
        alert('–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ—Å–ª–µ –¥–∞—Ç—ã –∑–∞–µ–∑–¥–∞');
        return false;
    }
    
    const checkinDate = new Date(checkin.value);
    const checkoutDate = new Date(checkout.value);
    const nights = Math.ceil((checkoutDate - checkinDate) / (1000 * 60 * 60 * 24));
    
    if (nights < 1) {
        alert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ - 1 –Ω–æ—á—å');
        return false;
    }
    
    if (!validatePhone(phone.value)) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ +7)');
        phone.style.borderColor = '#ef4444';
        phone.style.backgroundColor = '#fef2f2';
        phone.focus();
        return false;
    }
    
    const nameRegex = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å\s]+$/;
    if (!nameRegex.test(name.value.trim())) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è (—Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã)');
        name.style.borderColor = '#ef4444';
        name.style.backgroundColor = '#fef2f2';
        name.focus();
        return false;
    }
    
    return true;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã
function getFormData() {
    const checkin = document.getElementById('bookingCheckin').value;
    const checkout = document.getElementById('bookingCheckout').value;
    const apartment = document.getElementById('bookingApartment');
    const name = document.getElementById('bookingName').value;
    const phone = document.getElementById('bookingPhone').value;
    const email = document.getElementById('bookingEmail').value;
    const guests = document.getElementById('bookingGuests').value;
    const comment = document.getElementById('bookingComment').value;
    
    const checkinDate = new Date(checkin);
    const checkoutDate = new Date(checkout);
    const nights = Math.ceil((checkoutDate - checkinDate) / (1000 * 60 * 60 * 24));
    
    const apartmentText = apartment.options[apartment.selectedIndex].text;
    
    return {
        checkin,
        checkout,
        nights,
        apartment: apartmentText,
        name,
        phone,
        email,
        guests,
        comment
    };
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
async function sendToTelegram(formData) {
  const message = `
–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ!

üè† –ö–≤–∞—Ä—Ç–∏—Ä–∞: ${formData.apartment}
üìÖ –î–∞—Ç—ã: ${formData.checkin} - ${formData.checkout}
üë§ –ò–º—è: ${formData.name}
üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${formData.phone}
üìß Email: ${formData.email || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
üë• –ì–æ—Å—Ç–µ–π: ${formData.guests}
üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${formData.comment || '–Ω–µ—Ç'}
‚è∞ –í—Ä–µ–º—è: ${new Date().toLocaleString()}
  `.trim();

  const r = await fetch("/api/booking", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message })
  });

  const data = await r.json();
  return data.ok;
}

function setupRoomsPhotoCarousel() {
    const mainImg = document.getElementById('roomsGalleryImage');
    const dots = document.querySelectorAll('.rooms-dot');

    if (!mainImg || !dots.length) return;

    function setApartment(id) {
        const apt = apartments[id];
        if (!apt || !apt.images || !apt.images.length) return;

        mainImg.src = apt.images[0];
        mainImg.alt = `${apt.title} ‚Äî —Ñ–æ—Ç–æ`;
        mainImg.dataset.apartmentId = id;
    }

    // –∫–ª–∏–∫–∏ –ø–æ —Ç–æ—á–∫–∞–º
    dots.forEach((dot) => {
        dot.addEventListener('click', () => {
            const id = dot.getAttribute('data-apartment-id');

            dots.forEach(d => d.classList.remove('active'));
            dot.classList.add('active');

            setApartment(id);
        });
    });

    // —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—á–∫–µ
    const activeDot = document.querySelector('.rooms-dot.active') || dots[0];
    if (activeDot) {
        setApartment(activeDot.getAttribute('data-apartment-id'));
    }

    // –∫–ª–∏–∫ –ø–æ –±–æ–ª—å—à–æ–º—É —Ñ–æ—Ç–æ ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å –≥–∞–ª–µ—Ä–µ–µ–π —ç—Ç–æ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã
    mainImg.addEventListener('click', () => {
        const id = Number(mainImg.dataset.apartmentId || '1');
        openApartmentModal(id);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-message">${message}</span>
            <button class="notification-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ">√ó</button>
        </div>
    `;
    
    if (!document.querySelector('#notification-styles')) {
        const styles = document.createElement('style');
        styles.id = 'notification-styles';
        styles.textContent = `
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                border-left: 4px solid var(--accent);
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease;
            }
            
            .notification-success {
                border-left-color: #10b981;
            }
            
            .notification-error {
                border-left-color: #ef4444;
            }
            
            .notification-content {
                padding: 1rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 1rem;
            }
            
            .notification-message {
                flex: 1;
                color: var(--dark);
                font-size: 0.9rem;
            }
            
            .notification-close {
                background: none;
                border: none;
                font-size: 1.2rem;
                cursor: pointer;
                color: var(--secondary);
                padding: 0;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .notification-close:hover {
                color: var(--dark);
            }
            
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @media (max-width: 768px) {
                .notification {
                    left: 20px;
                    right: 20px;
                    max-width: none;
                }
            }
        `;
        document.head.appendChild(styles);
    }
    
    document.body.appendChild(notification);
    
    notification.querySelector('.notification-close').addEventListener('click', function() {
        notification.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    });
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
    }, 5000);
}

// –ü–æ–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
async function showBookingSuccess() {
    const form = document.getElementById('bookingForm');
    const submitBtn = form.querySelector('.submit-btn');
    
    if (!submitBtn) return;
    
    const originalHtml = submitBtn.innerHTML;
    
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    form.classList.add('form-loading');
    
    try {
        const formData = getFormData();
        const isSent = await sendToTelegram(formData);
        
        if (isSent) {
            submitBtn.classList.remove('loading');
            submitBtn.classList.add('success');
            submitBtn.querySelector('.btn-text').textContent = '‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!';
            
            setTimeout(() => {
                closeBookingModal();
                form.reset();
                submitBtn.classList.remove('success', 'loading');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHtml;
                form.classList.remove('form-loading');
                
                showNotification('–°–ø–∞—Å–∏–±–æ! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.', 'success');
            }, 2000);
        } else {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É');
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        
        submitBtn.classList.remove('loading');
        submitBtn.classList.add('error');
        submitBtn.querySelector('.btn-text').textContent = '‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏';
        
        setTimeout(() => {
            submitBtn.classList.remove('error', 'loading');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalHtml;
            form.classList.remove('form-loading');
            
            showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º –Ω–∞–ø—Ä—è–º—É—é.', 'error');
        }, 2000);
    }
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
function setupBookingForm() {
    const form = document.getElementById('bookingForm');
    const checkinInput = document.getElementById('bookingCheckin');
    const checkoutInput = document.getElementById('bookingCheckout');
    
    if (!form) return;
    
    let isSubmitting = false;
    
    if (checkinInput) {
        checkinInput.addEventListener('change', function() {
            if (this.value && checkoutInput) {
                checkoutInput.min = this.value;
                if (checkoutInput.value && checkoutInput.value <= this.value) {
                    checkoutInput.value = '';
                }
            }
        });
    }
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (isSubmitting) return;
        
        if (!validateBookingForm()) {
            return;
        }
        
        isSubmitting = true;
        showBookingSuccess().finally(() => {
            isSubmitting = false;
        });
    });
}

function updateCarouselPreview(index) {
  const preview = document.getElementById('roomsPreviewImage');
  if (!preview) return;

  const apartmentId = index + 1; // —Ç.–∫. —Å–ª–∞–π–¥—ã –∏–¥—É—Ç 0..N, –∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã —É –Ω–∞—Å 1..N
  const apt = apartments[apartmentId];

  if (!apt || !apt.images || !apt.images.length) return;

  preview.src = apt.images[0];
  preview.alt = `${apt.title} ‚Äî –ø—Ä–µ–≤—å—é`;
}

function initCarousel() {
  const viewport = document.querySelector('.rooms-carousel .carousel-viewport');
  const track    = document.querySelector('.rooms-carousel .carousel-track');
  const slides   = track ? track.querySelectorAll('.carousel-slide') : [];
  const prevBtn  = document.querySelector('.rooms-carousel .carousel-prev');
  const nextBtn  = document.querySelector('.rooms-carousel .carousel-next');
  const curEl    = document.querySelector('.rooms-carousel .current-slide');
  const totalEl  = document.querySelector('.rooms-carousel .total-slides');

  if (!viewport || !track || !slides.length) return;

  let index = 0;
  const GAP = parseInt(getComputedStyle(track).gap) || 16;

  totalEl && (totalEl.textContent = String(slides.length));

  function update() {
    const slideW = slides[0].offsetWidth;
    track.style.transform = `translateX(${-index * (slideW + GAP)}px)`;
    curEl && (curEl.textContent = String(index + 1));
    slides.forEach((s, i) => s.classList.toggle('active', i === index));

    // –û–ë–ù–û–í–õ–Ø–ï–ú –§–û–¢–û –ü–û–î –¢–ï–ö–£–©–£–Æ –ö–í–ê–†–¢–ò–†–£
    updateCarouselPreview(index);
  }

  prevBtn?.addEventListener('click', () => {
    index = (index - 1 + slides.length) % slides.length;
    update();
  });

  nextBtn?.addEventListener('click', () => {
    index = (index + 1) % slides.length;
    update();
  });

  // —Å–≤–∞–π–ø—ã
  let sx = 0, dx = 0;
  viewport.addEventListener('touchstart', (e) => { sx = e.touches[0].clientX; }, { passive:true });
  viewport.addEventListener('touchend',   (e) => {
    dx = e.changedTouches[0].clientX;
    if (sx - dx > 50) { index = (index + 1) % slides.length; update(); }
    if (dx - sx > 50) { index = (index - 1 + slides.length) % slides.length; update(); }
  }, { passive:true });

  // –∞–≤—Ç–æ–ª–∏—Å—Ç–∞–Ω–∏–µ
  let timer = setInterval(() => {
    index = (index + 1) % slides.length;
    update();
  }, 5000);

  viewport.addEventListener('mouseenter', () => clearInterval(timer));
  viewport.addEventListener('mouseleave', () => {
    clearInterval(timer);
    timer = setInterval(() => {
      index = (index + 1) % slides.length;
      update();
    }, 5000);
  });

  window.addEventListener('resize', update);
  update(); // —Å—Ä–∞–∑—É –≤—ã—Å—Ç–∞–≤–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –ø–æ–∑–∏—Ü–∏—é
}

function setupRoomsStrip() {
    const mainImg = document.getElementById('roomsMainImage');
    const items = document.querySelectorAll('.rooms-item');

    if (!mainImg || !items.length) return;

    items.forEach((btn) => {
        btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-apartment-id');
            const apt = apartments[id];

            if (!apt || !apt.images || !apt.images.length) return;

            // –º–µ–Ω—è–µ–º —Ñ–æ—Ç–æ
            mainImg.src = apt.images[0];
            mainImg.alt = `${apt.title} ‚Äî —Ñ–æ—Ç–æ`;

            // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            items.forEach((b) => b.classList.remove('active'));
            btn.classList.add('active');

            // –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫–Ω–æ–ø–∫—É –µ—â—ë –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É (–µ—Å–ª–∏ —Ö–æ—á–µ—à—å)
            // openApartmentModal(Number(id));
        });
    });

    // –Ω–∞ —Å—Ç–∞—Ä—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É —Å –ø–µ—Ä–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π
    const active = document.querySelector('.rooms-item.active');
    if (active) {
        const id = active.getAttribute('data-apartment-id');
        const apt = apartments[id];
        if (apt && apt.images && apt.images.length) {
            mainImg.src = apt.images[0];
            mainImg.alt = `${apt.title} ‚Äî —Ñ–æ—Ç–æ`;
        }
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    setupImageErrorHandling();
    setupLazyLoading();
    enhanceMobileUX();
    setupPhoneMask();
    setupHeaderScroll();
    setupRoomsSlider();
    
    // –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é
    const menuToggle = document.getElementById('menuToggle');
    const navList = document.querySelector('.nav-list');
    
    if (menuToggle && navList) {
        menuToggle.addEventListener('click', function() {
            const isExpanded = navList.classList.toggle('active');
            menuToggle.textContent = isExpanded ? '‚úï' : '‚ò∞';
            menuToggle.setAttribute('aria-expanded', isExpanded);
            document.body.style.overflow = isExpanded ? 'hidden' : 'auto';
        });
        
        document.querySelectorAll('.nav-list a').forEach(link => {
            link.addEventListener('click', function() {
                navList.classList.remove('active');
                menuToggle.textContent = '‚ò∞';
                menuToggle.setAttribute('aria-expanded', 'false');
                document.body.style.overflow = 'auto';
            });
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    const bookButtons = document.querySelectorAll('.book-btn, .cta-button');
    bookButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            openBookingModal();
        });
    });
    
    // –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö —Ç–æ–∂–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    const detailButtons = document.querySelectorAll('.card-btn');
    detailButtons.forEach((btn, index) => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    openApartmentModal(index + 1);
  });
});
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    setupBookingForm();
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function() {
            closeApartmentModal();
            closeBookingModal();
        });
    });
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeApartmentModal();
        closeBookingModal();
    }
    if (e.key === 'ArrowRight') nextImage();
    if (e.key === 'ArrowLeft') prevImage();
});

console.log('DonSide apartments carousel loaded with improved navigation!');